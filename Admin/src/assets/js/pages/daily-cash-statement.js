$(document).ready(function() {
    // Set today's date as default for both fields
    const today = new Date().toISOString().split('T')[0];
    $('#startDate').val(today);
    $('#endDate').val(today);
    
    // Load today's statement by default
    loadToday();
});

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount || 0);
}

function formatDateTime(dateString) {
    return new Date(dateString).toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

function getDateRange(period) {
    const today = new Date();
    let startDate, endDate;
    
    switch(period) {
        case 'today':
            startDate = today;
            endDate = today;
            break;
        case 'week':
            // Start of week (Sunday)
            startDate = new Date(today);
            startDate.setDate(today.getDate() - today.getDay());
            endDate = today;
            break;
        case 'month':
            // Start of month
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = today;
            break;
        default:
            startDate = today;
            endDate = today;
    }
    
    return {
        start: startDate.toISOString().split('T')[0],
        end: endDate.toISOString().split('T')[0]
    };
}

// Quick access functions
window.loadToday = function() {
    const range = getDateRange('today');
    $('#startDate').val(range.start);
    $('#endDate').val(range.end);
    loadStatementRange();
};

window.loadThisWeek = function() {
    const range = getDateRange('week');
    $('#startDate').val(range.start);
    $('#endDate').val(range.end);
    loadStatementRange();
};

window.loadThisMonth = function() {
    const range = getDateRange('month');
    $('#startDate').val(range.start);
    $('#endDate').val(range.end);
    loadStatementRange();
};

// Load statement for date range
window.loadStatementRange = async function() {
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();
    
    if (!startDate || !endDate) {
        if (typeof Swal !== 'undefined') {
            Swal.fire('Error', 'Please select both start and end dates', 'error');
        } else {
            alert('Please select both start and end dates');
        }
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        if (typeof Swal !== 'undefined') {
            Swal.fire('Error', 'Start date cannot be after end date', 'error');
        } else {
            alert('Start date cannot be after end date');
        }
        return;
    }
    
    // Show loading
    $('#statementContent').html(`
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading cash statement...</p>
        </div>
    `);

    try {
        // Use the admin reports endpoint for date range
        const response = await api.request(`/admin/reports/cash-statement?startDate=${startDate}&endDate=${endDate}`);
        
        // Determine the date display
        const isSingleDay = startDate === endDate;
        const dateDisplay = isSingleDay 
            ? formatDate(startDate)
            : `${formatDate(startDate)} - ${formatDate(endDate)}`;
        
        const reportTitle = isSingleDay ? 'Daily Cash Statement' : 'Cash Statement';
        
        let tableRows = '';
        if (response.payments && response.payments.length > 0) {
            response.payments.forEach((payment, index) => {
                tableRows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${payment.receipt_number}</td>
                        <td>${payment.policy_number}</td>
                        <td>${payment.customer_name}</td>
                        <td class="text-end">${formatCurrency(payment.amount)}</td>
                        <td>${payment.payment_method || 'N/A'}</td>
                        <td>${formatDateTime(payment.date)}</td>
                        <td>${payment.received_by || 'N/A'}</td>
                    </tr>
                `;
            });
        } else {
            tableRows = '<tr><td colspan="8" class="text-center text-muted py-4">No payments recorded for this period</td></tr>';
        }
        
        // Get current user for the generated by field
        let generatedBy = 'System';
        try {
            const user = await api.getCurrentUser();
            generatedBy = user.full_name || user.username;
        } catch (e) {}
        
        const statementHTML = `
            <div id="printableStatement" style="border: 2px solid #000; padding: 20px; margin: 0 auto; max-width: 100%;">
                <div class="text-center mb-4">
                    <img src="assets/images/IC-LOGO-NEW.png" alt="Combined Insurance Services (St.Lucia) Ltd." style="height: 60px;" class="mb-2" onerror="this.style.display='none'">
                    <h3 class="mb-1" style="color: #1a365d;">Combined Insurance Services (St.Lucia) Ltd.</h3>
                    <h4 class="text-muted">${reportTitle}</h4>
                    <p class="mb-0"><strong>Period:</strong> ${dateDisplay}</p>
                    <p class="text-muted small">Generated: ${formatDateTime(new Date().toISOString())} by ${generatedBy}</p>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Receipt Number</th>
                                <th>Policy Number</th>
                                <th>Customer</th>
                                <th class="text-end">Amount</th>
                                <th>Payment Method</th>
                                <th>Payment Date</th>
                                <th>Received By</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                        <tfoot>
                            <tr class="table-primary fw-bold">
                                <th colspan="4" class="text-end">Total:</th>
                                <th class="text-end">${formatCurrency(response.total)}</th>
                                <th colspan="3">Total Transactions: ${response.payments ? response.payments.length : 0}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="mt-4 pt-3 border-top">
                    <div class="row">
                        <div class="col-md-4">
                            <p class="mb-1"><strong>Prepared By:</strong></p>
                            <p class="border-bottom pb-3">${generatedBy}</p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1"><strong>Verified By:</strong></p>
                            <p class="border-bottom pb-3">_______________________</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <p class="mb-1"><strong>Date:</strong></p>
                            <p>${formatDate(new Date().toISOString())}</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4 text-muted small">
                    <p class="mb-0">Combined Insurance Services (St.Lucia) Ltd. - P.O. GM 636, Gablewoods Mall, Castries, St.Lucia</p>
                    <p class="mb-0">Tel: 758 456-0700 | Email: info@combinedinsuranceslu.com | www.combinedinsuranceslu.com</p>
                    <p class="mb-0">Designed by Solace-Systems</p>
                </div>
            </div>
        `;
        
        $('#statementContent').html(statementHTML);
        lucide.createIcons();
    } catch (error) {
        console.error('Error loading statement:', error);
        if (typeof Swal !== 'undefined') {
            Swal.fire('Error', error.message || 'Failed to load statement', 'error');
        }
        $('#statementContent').html(`
            <div class="alert alert-danger">
                <h5><i data-lucide="alert-circle" class="icon-sm me-2"></i>Error</h5>
                <p class="mb-0">${error.message || 'Failed to load cash statement'}</p>
            </div>
        `);
        lucide.createIcons();
    }
};

// Legacy function for backward compatibility
window.loadStatement = function() {
    loadStatementRange();
};

// Export to PDF
window.exportPDF = function() {
    const element = document.getElementById('printableStatement');
    
    if (!element) {
        if (typeof Swal !== 'undefined') {
            Swal.fire('Info', 'Please load a statement first before exporting', 'info');
        } else {
            alert('Please load a statement first before exporting');
        }
        return;
    }
    
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();
    const filename = startDate === endDate 
        ? `cash-statement-${startDate}.pdf`
        : `cash-statement-${startDate}-to-${endDate}.pdf`;
    
    const opt = {
        margin: 10,
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
    };
    
    // Show loading
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: 'Generating PDF...',
            text: 'Please wait',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });
    }
    
    html2pdf().set(opt).from(element).save().then(() => {
        if (typeof Swal !== 'undefined') {
            Swal.close();
            Swal.fire({
                title: 'Success!',
                text: 'PDF exported successfully',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
        }
    }).catch(err => {
        if (typeof Swal !== 'undefined') {
            Swal.fire('Error', 'Failed to generate PDF', 'error');
        }
        console.error('PDF export error:', err);
    });
};
