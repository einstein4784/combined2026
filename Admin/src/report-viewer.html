@@include('partials/main.html')

<head>
    @@include("partials/title-meta.html", {"title": "Report Viewer"})

    @@include('partials/head-css.html')
    <link href="assets/libs/sweetalert2/sweetalert2.min.css" rel="stylesheet" type="text/css" />
    
    <style>
        /* Print styles */
        @media print {
            .no-print, .navbar-custom, .main-menu, .footer, .sidenav-menu { display: none !important; }
            body { background: #fff !important; }
            .report-container { box-shadow: none !important; margin: 0 !important; }
            .content-page { margin: 0 !important; padding: 0 !important; min-height: auto !important; }
            .container-fluid { padding: 0 !important; }
            .content { padding: 0 !important; }
        }
        
        /* Report Toolbar */
        .report-toolbar {
            background: linear-gradient(135deg, #1a365d 0%, #2c4a7c 100%) !important;
            padding: 15px 30px !important;
            border-radius: 12px !important;
            margin-bottom: 20px !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            flex-wrap: wrap !important;
            gap: 15px !important;
        }
        
        .report-toolbar h5 {
            color: #fff !important;
            margin: 0 !important;
            font-weight: 600 !important;
            display: flex !important;
            align-items: center !important;
        }
        
        .report-toolbar .btn {
            border-radius: 8px !important;
            padding: 10px 20px !important;
            font-weight: 500 !important;
        }
        
        /* Report Container */
        .report-container {
            background: #fff !important;
            border-radius: 12px !important;
            box-shadow: 0 4px 20px rgba(26, 54, 93, 0.1) !important;
            overflow: hidden !important;
        }
        
        /* Report Header */
        .report-header {
            background: linear-gradient(135deg, #1a365d 0%, #2c4a7c 100%) !important;
            color: #fff !important;
            padding: 40px 40px 60px 40px !important;
            text-align: center !important;
            position: relative !important;
        }
        
        .report-header::after {
            content: '' !important;
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            height: 40px !important;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 100'%3E%3Cpath fill='%239dd5c4' fill-opacity='0.3' d='M0,50L60,45C120,40,240,30,360,35C480,40,600,60,720,65C840,70,960,60,1080,50C1200,40,1320,30,1380,25L1440,20L1440,100L0,100Z'%3E%3C/path%3E%3Cpath fill='%23c9a962' fill-opacity='0.25' d='M0,70L60,68C120,66,240,62,360,60C480,58,600,58,720,62C840,66,960,74,1080,76C1200,78,1320,74,1380,72L1440,70L1440,100L0,100Z'%3E%3C/path%3E%3C/svg%3E") no-repeat bottom !important;
            background-size: cover !important;
        }
        
        .company-logo-text {
            font-size: 56px !important;
            font-weight: 800 !important;
            letter-spacing: -2px !important;
            margin-bottom: 10px !important;
        }
        
        .company-logo-text .logo-i { color: #fff !important; }
        .company-logo-text .logo-amp { color: #c9a962 !important; font-size: 42px !important; }
        .company-logo-text .logo-c { color: #9dd5c4 !important; }
        
        .company-name {
            font-size: 18px !important;
            font-weight: 600 !important;
            letter-spacing: 4px !important;
            text-transform: uppercase !important;
            color: #fff !important;
        }
        
        .company-location {
            font-size: 13px !important;
            letter-spacing: 2px !important;
            color: rgba(255,255,255,0.8) !important;
            margin-top: 5px !important;
        }
        
        .report-title {
            font-size: 24px !important;
            font-weight: 600 !important;
            margin-top: 25px !important;
            padding-top: 20px !important;
            border-top: 1px solid rgba(255,255,255,0.2) !important;
            color: #fff !important;
        }
        
        /* Report Meta */
        .report-meta {
            background: linear-gradient(135deg, rgba(157, 213, 196, 0.15) 0%, rgba(79, 168, 150, 0.1) 100%) !important;
            padding: 20px 40px !important;
            display: flex !important;
            justify-content: space-between !important;
            flex-wrap: wrap !important;
            gap: 20px !important;
            border-bottom: 1px solid rgba(26, 54, 93, 0.1) !important;
        }
        
        .meta-item {
            text-align: center !important;
            flex: 1 !important;
            min-width: 120px !important;
        }
        
        .meta-item span {
            display: block !important;
            color: #6c757d !important;
            font-size: 11px !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
        }
        
        .meta-item strong {
            display: block !important;
            color: #1a365d !important;
            font-size: 14px !important;
            margin-top: 5px !important;
        }
        
        /* Report Summary */
        .report-summary {
            background: linear-gradient(135deg, rgba(79, 168, 150, 0.08) 0%, rgba(157, 213, 196, 0.08) 100%) !important;
            padding: 30px 40px !important;
            margin: 25px 40px !important;
            border-radius: 12px !important;
            border-left: 4px solid #4fa896 !important;
        }
        
        .report-summary h5 {
            color: #1a365d !important;
            font-weight: 600 !important;
            margin-bottom: 20px !important;
            font-size: 16px !important;
            display: flex !important;
            align-items: center !important;
        }
        
        .summary-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important;
            gap: 20px !important;
        }
        
        .summary-item {
            text-align: center !important;
            padding: 20px 15px !important;
            background: #fff !important;
            border-radius: 10px !important;
            box-shadow: 0 2px 10px rgba(26, 54, 93, 0.08) !important;
        }
        
        .summary-item .value {
            font-size: 32px !important;
            font-weight: 700 !important;
            color: #4fa896 !important;
        }
        
        .summary-item .label {
            font-size: 11px !important;
            color: #6c757d !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            margin-top: 8px !important;
        }
        
        /* Report Content */
        .report-content {
            padding: 30px 40px !important;
        }
        
        .report-table {
            width: 100% !important;
            border-collapse: collapse !important;
            font-size: 13px !important;
        }
        
        .report-table thead th {
            background: linear-gradient(135deg, #1a365d 0%, #2c4a7c 100%) !important;
            color: #fff !important;
            padding: 14px 16px !important;
            text-align: left !important;
            font-size: 11px !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            font-weight: 600 !important;
        }
        
        .report-table tbody td {
            padding: 12px 16px !important;
            border-bottom: 1px solid #eee !important;
            color: #333 !important;
        }
        
        .report-table tbody tr:nth-child(even) {
            background: rgba(157, 213, 196, 0.05) !important;
        }
        
        .report-table tbody tr:hover {
            background: rgba(79, 168, 150, 0.1) !important;
        }
        
        .report-table tfoot td {
            background: linear-gradient(135deg, rgba(26, 54, 93, 0.08) 0%, rgba(44, 74, 124, 0.08) 100%) !important;
            font-weight: 600 !important;
            padding: 14px 16px !important;
            color: #1a365d !important;
        }
        
        /* Report Footer */
        .report-footer {
            background: linear-gradient(135deg, rgba(26, 54, 93, 0.03) 0%, rgba(44, 74, 124, 0.03) 100%) !important;
            padding: 40px !important;
            margin-top: 30px !important;
            border-top: 1px solid #eee !important;
        }
        
        .certification-text {
            text-align: center !important;
            font-style: italic !important;
            color: #6c757d !important;
            margin-bottom: 40px !important;
        }
        
        .signature-section {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 60px !important;
            max-width: 600px !important;
            margin: 0 auto !important;
        }
        
        .signature-box {
            text-align: center !important;
        }
        
        .signature-line {
            border-top: 1px solid #1a365d !important;
            margin-top: 60px !important;
            padding-top: 12px !important;
        }
        
        .signature-title {
            color: #6c757d !important;
            font-size: 12px !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
        }
        
        .generated-info {
            margin-top: 40px !important;
            padding-top: 20px !important;
            border-top: 1px dashed #ccc !important;
            text-align: center !important;
            font-size: 11px !important;
            color: #999 !important;
        }
        
        .amount-cell {
            font-family: 'Courier New', monospace !important;
            text-align: right !important;
        }
        
        .status-badge {
            padding: 4px 12px !important;
            border-radius: 20px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
        }
        
        .status-active { background: rgba(79, 168, 150, 0.15) !important; color: #3d8a7a !important; }
        .status-paid { background: rgba(79, 168, 150, 0.15) !important; color: #3d8a7a !important; }
        .status-pending { background: rgba(201, 169, 98, 0.15) !important; color: #9a7c3e !important; }
        .status-overdue { background: rgba(220, 53, 69, 0.15) !important; color: #dc3545 !important; }
    </style>
</head>

<body>
    <div id="wrapper">

        @@include('partials/sidenav.html')

        <div class="content-page">

            @@include('partials/topbar.html')

            <div class="content">
                <!-- Start Content-->
                <div class="container-fluid">
                    
                    <!-- Report Toolbar - Always Visible -->
                    <div class="report-toolbar no-print" id="reportToolbar">
                        <div>
                            <h5><i data-lucide="file-text" class="me-2" style="width:20px;height:20px;"></i> <span id="toolbarTitle">Report Viewer</span></h5>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="admin-settings.html" class="btn btn-light">
                                <i data-lucide="arrow-left" class="me-1" style="width:16px;height:16px;"></i> Back to Reports
                            </a>
                            <button class="btn btn-warning text-dark" onclick="window.print()">
                                <i data-lucide="printer" class="me-1" style="width:16px;height:16px;"></i> Print
                            </button>
                            <button class="btn btn-success" onclick="exportToPDF()">
                                <i data-lucide="download" class="me-1" style="width:16px;height:16px;"></i> Export PDF
                            </button>
                        </div>
                    </div>

                    <!-- Report Container -->
                    <div class="report-container" id="reportContainer">
                        <!-- Report Header with Logo -->
                        <div class="report-header" id="reportHeader">
                            <div class="company-logo-text">
                                <span class="logo-i">I</span><span class="logo-amp">&</span><span class="logo-c">C</span>
                            </div>
                            <div class="company-name">INSURANCE BROKERS</div>
                            <div class="company-location">ST. LUCIA</div>
                            <div class="report-title" id="reportTitle">Report</div>
                        </div>
                        
                        <!-- Report Meta Information -->
                        <div class="report-meta" id="reportMeta">
                            <div class="meta-item">
                                <span>Report Date</span>
                                <strong id="metaReportDate">--</strong>
                            </div>
                            <div class="meta-item">
                                <span>Generated By</span>
                                <strong id="metaGeneratedBy">--</strong>
                            </div>
                            <div class="meta-item">
                                <span>Date Range</span>
                                <strong id="metaDateRange">--</strong>
                            </div>
                            <div class="meta-item">
                                <span>Report ID</span>
                                <strong id="metaReportId">--</strong>
                            </div>
                        </div>
                        
                        <!-- Report Summary -->
                        <div class="report-summary" id="reportSummary">
                            <h5><i data-lucide="bar-chart-2" class="me-2" style="width:18px;height:18px;"></i> Summary</h5>
                            <div class="summary-grid" id="summaryGrid">
                                <!-- Summary items will be inserted here -->
                            </div>
                        </div>
                        
                        <!-- Report Data Table -->
                        <div class="report-content">
                            <table class="report-table" id="reportTable">
                                <thead id="reportTableHead">
                                    <!-- Headers will be inserted here -->
                                </thead>
                                <tbody id="reportTableBody">
                                    <!-- Data will be inserted here -->
                                </tbody>
                                <tfoot id="reportTableFoot">
                                    <!-- Totals will be inserted here -->
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- Report Footer with Signatures -->
                        <div class="report-footer">
                            <p class="certification-text">
                                I certify that the information contained in this report is accurate and complete to the best of my knowledge.
                            </p>
                            
                            <div class="signature-section">
                                <div class="signature-box">
                                    <div class="signature-line">
                                        <div class="signature-title">Prepared By</div>
                                    </div>
                                </div>
                                <div class="signature-box">
                                    <div class="signature-line">
                                        <div class="signature-title">Authorized Signature</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="generated-info" id="generatedInfo">
                                Report generated on <span id="generatedDate">--</span> at <span id="generatedTime">--</span>
                                by <span id="generatedUser">--</span> | I&C Insurance Brokers, St. Lucia
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            @@include('partials/footer.html')
        </div>
    </div>

    @@include('partials/footer-scripts.html')
    <script src="assets/libs/sweetalert2/sweetalert2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        // Report data storage
        let reportData = null;
        
        $(document).ready(function() {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Get report data from session storage
            const storedData = sessionStorage.getItem('reportData');
            console.log('Report data from session:', storedData);
            
            if (storedData) {
                try {
                    reportData = JSON.parse(storedData);
                    console.log('Parsed report data:', reportData);
                    renderReport(reportData);
                } catch (e) {
                    console.error('Error parsing report data:', e);
                    showNoDataMessage();
                }
            } else {
                console.log('No report data found in session storage');
                showNoDataMessage();
            }
        });
        
        function showNoDataMessage() {
            $('#reportTitle').text('No Report Available');
            $('#reportSummary').hide();
            $('#reportTableBody').html('<tr><td colspan="10" class="text-center py-5 text-muted"><i data-lucide="alert-circle" style="width:48px;height:48px;margin-bottom:15px;"></i><br><strong>No report data available</strong><br>Please go back and generate a report first.</td></tr>');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        function renderReport(data) {
            console.log('Rendering report with data:', data);
            
            const now = new Date();
            const userDataStr = localStorage.getItem('userData');
            const userData = userDataStr ? JSON.parse(userDataStr) : { fullName: 'System', role: 'Admin' };
            
            // Set toolbar and page title
            const title = data.title || 'Report';
            $('#toolbarTitle').text(title);
            $('#reportTitle').text(title);
            document.title = title + ' | I&C Insurance Brokers';
            
            // Set meta information
            $('#metaReportDate').text(now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }));
            $('#metaGeneratedBy').text(`${userData.fullName || 'System'} (${userData.role || 'Admin'})`);
            $('#metaDateRange').text(data.dateRange || 'All Time');
            $('#metaReportId').text('RPT-' + Date.now().toString(36).toUpperCase());
            
            // Set generated info footer
            $('#generatedDate').text(now.toLocaleDateString());
            $('#generatedTime').text(now.toLocaleTimeString());
            $('#generatedUser').text(userData.fullName || 'System');
            
            // Render summary section
            if (data.summary && data.summary.length > 0) {
                let summaryHtml = '';
                data.summary.forEach(item => {
                    summaryHtml += `
                        <div class="summary-item">
                            <div class="value">${item.value}</div>
                            <div class="label">${item.label}</div>
                        </div>
                    `;
                });
                $('#summaryGrid').html(summaryHtml);
                $('#reportSummary').show();
            } else {
                $('#reportSummary').hide();
            }
            
            // Render table headers
            if (data.headers && data.headers.length > 0) {
                let headerHtml = '<tr>';
                data.headers.forEach(h => {
                    headerHtml += `<th>${escapeHtml(h)}</th>`;
                });
                headerHtml += '</tr>';
                $('#reportTableHead').html(headerHtml);
            }
            
            // Render table body
            if (data.rows && data.rows.length > 0) {
                let bodyHtml = '';
                data.rows.forEach(row => {
                    bodyHtml += '<tr>';
                    row.forEach((cell) => {
                        let cellClass = '';
                        let cellContent = cell;
                        
                        if (typeof cell === 'string') {
                            // Check for currency formatting
                            if (cell.startsWith('$') || cell.match(/^\$[\d,]+\.?\d*$/)) {
                                cellClass = 'amount-cell';
                            }
                            // Status badges
                            if (cell === 'Active' || cell === 'Paid') {
                                cellContent = `<span class="status-badge status-active">${cell}</span>`;
                            } else if (cell === 'Pending') {
                                cellContent = `<span class="status-badge status-pending">${cell}</span>`;
                            } else if (cell === 'Overdue' || cell === 'Cancelled') {
                                cellContent = `<span class="status-badge status-overdue">${cell}</span>`;
                            }
                        }
                        bodyHtml += `<td class="${cellClass}">${cellContent}</td>`;
                    });
                    bodyHtml += '</tr>';
                });
                $('#reportTableBody').html(bodyHtml);
            } else {
                $('#reportTableBody').html('<tr><td colspan="10" class="text-center py-4 text-muted">No data available</td></tr>');
            }
            
            // Render footer/totals
            if (data.totals && data.totals.length > 0) {
                let footHtml = '<tr>';
                data.totals.forEach(t => {
                    footHtml += `<td>${t}</td>`;
                });
                footHtml += '</tr>';
                $('#reportTableFoot').html(footHtml);
            }
            
            // Re-initialize icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function exportToPDF() {
            const element = document.getElementById('reportContainer');
            const reportTitle = reportData?.title || 'Report';
            
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `IC_${reportTitle.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    letterRendering: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait' 
                }
            };
            
            // Show loading
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: 'Generating PDF...',
                    text: 'Please wait while we prepare your document...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
            }
            
            html2pdf().set(opt).from(element).save().then(() => {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'Success!',
                        text: 'PDF has been downloaded',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            }).catch(err => {
                console.error('PDF export error:', err);
                if (typeof Swal !== 'undefined') {
                    Swal.fire('Error', 'Failed to generate PDF. Please try printing instead.', 'error');
                }
            });
        }
    </script>
</body>
</html>
