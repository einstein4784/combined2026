<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Report Viewer | Combined Insurance Services (St.Lucia) Ltd.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="assets/images/favicon.ico">
    <link href="assets/libs/sweetalert2/sweetalert2.min.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f4f6f9;
            color: #333;
            line-height: 1.5;
        }
        
        /* Print styles */
        @media print {
            @page {
                size: A4;
                margin: 0.5in;
            }
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body { 
                background: #fff !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .no-print { display: none !important; }
            .report-page { 
                padding: 0 !important;
                margin: 0 !important;
            }
            .report-container { 
                max-width: 100% !important;
                margin: 0 auto !important;
                padding: 20px !important;
                border: 2px solid #000 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                page-break-inside: avoid !important;
            }
            .report-header {
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            .report-summary {
                page-break-inside: avoid !important;
            }
            img { 
                max-width: 100% !important;
                height: auto !important;
                page-break-inside: avoid !important;
            }
            table {
                page-break-inside: auto !important;
                border-collapse: collapse !important;
            }
            thead {
                display: table-header-group !important;
            }
            tbody {
                display: table-row-group !important;
            }
            tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }
        }
        
        .report-page {
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Toolbar */
        .report-toolbar {
            background: linear-gradient(135deg, #1a365d 0%, #2c4a7c 100%);
            padding: 12px 24px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .report-toolbar h5 {
            color: #fff;
            margin: 0;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toolbar-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .btn-light {
            background: #fff;
            color: #1a365d;
        }
        
        .btn-light:hover {
            background: #f0f0f0;
        }
        
        .btn-warning {
            background: #c9a962;
            color: #1a365d;
        }
        
        .btn-warning:hover {
            background: #b89952;
        }
        
        .btn-success {
            background: #4fa896;
            color: #fff;
        }
        
        .btn-success:hover {
            background: #3d8a7a;
        }
        
        /* Report Container */
        .report-container {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(26, 54, 93, 0.1);
            overflow: hidden;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Report Header */
        .report-header {
            background: linear-gradient(135deg, #1a365d 0%, #2c4a7c 100%);
            color: #fff;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }
        
        .report-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 15px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 100'%3E%3Cpath fill='%239dd5c4' fill-opacity='0.3' d='M0,50L60,45C120,40,240,30,360,35C480,40,600,60,720,65C840,70,960,60,1080,50C1200,40,1320,30,1380,25L1440,20L1440,100L0,100Z'%3E%3C/path%3E%3Cpath fill='%23c9a962' fill-opacity='0.25' d='M0,70L60,68C120,66,240,62,360,60C480,58,600,58,720,62C840,66,960,74,1080,76C1200,78,1320,74,1380,72L1440,70L1440,100L0,100Z'%3E%3C/path%3E%3C/svg%3E") no-repeat bottom;
            background-size: cover;
        }
        
        .company-logo-text {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
            margin-bottom: 2px;
        }
        
        .logo-i { color: #fff; }
        .logo-amp { color: #c9a962; font-size: 24px; }
        .logo-c { color: #9dd5c4; }
        
        .company-name {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .company-location {
            font-size: 9px;
            letter-spacing: 2px;
            color: rgba(255,255,255,0.8);
            margin-top: 2px;
        }
        
        .report-title {
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        /* Report Meta */
        .report-meta {
            background: linear-gradient(135deg, rgba(157, 213, 196, 0.15) 0%, rgba(79, 168, 150, 0.1) 100%);
            padding: 12px 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            border-bottom: 1px solid rgba(26, 54, 93, 0.1);
        }
        
        .meta-item {
            text-align: center;
        }
        
        .meta-item span {
            display: block;
            color: #6c757d;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .meta-item strong {
            display: block;
            color: #1a365d;
            font-size: 12px;
            margin-top: 2px;
        }
        
        /* Report Summary */
        .report-summary {
            background: linear-gradient(135deg, rgba(79, 168, 150, 0.08) 0%, rgba(157, 213, 196, 0.08) 100%);
            padding: 15px 20px;
            margin: 15px 20px;
            border-radius: 8px;
            border-left: 3px solid #4fa896;
        }
        
        .report-summary h5 {
            color: #1a365d;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        
        .summary-item {
            text-align: center;
            padding: 12px 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(26, 54, 93, 0.06);
        }
        
        .summary-item .value {
            font-size: 24px;
            font-weight: 700;
            color: #4fa896;
        }
        
        .summary-item .label {
            font-size: 9px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-top: 4px;
        }
        
        /* Report Content */
        .report-content {
            padding: 15px 20px;
            overflow-x: auto;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        
        .report-table thead th {
            background: linear-gradient(135deg, #1a365d 0%, #2c4a7c 100%);
            color: #fff;
            padding: 10px 12px;
            text-align: left;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .report-table tbody td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            color: #333;
        }
        
        .report-table tbody tr:nth-child(even) {
            background: rgba(157, 213, 196, 0.05);
        }
        
        .report-table tbody tr:hover {
            background: rgba(79, 168, 150, 0.1);
        }
        
        .report-table tfoot td {
            background: linear-gradient(135deg, rgba(26, 54, 93, 0.08) 0%, rgba(44, 74, 124, 0.08) 100%);
            font-weight: 600;
            padding: 10px 12px;
            color: #1a365d;
        }
        
        /* Report Footer */
        .report-footer {
            background: linear-gradient(135deg, rgba(26, 54, 93, 0.03) 0%, rgba(44, 74, 124, 0.03) 100%);
            padding: 20px;
            margin-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .certification-text {
            text-align: center;
            font-style: italic;
            color: #6c757d;
            margin-bottom: 20px;
            font-size: 11px;
        }
        
        .signature-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 40px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .signature-box {
            text-align: center;
        }
        
        .signature-line {
            border-top: 1px solid #1a365d;
            margin-top: 40px;
            padding-top: 8px;
        }
        
        .signature-title {
            color: #6c757d;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .generated-info {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
            text-align: center;
            font-size: 9px;
            color: #999;
        }
        
        .amount-cell {
            font-family: 'Courier New', monospace;
            text-align: right;
        }
        
        .status-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .status-active, .status-paid { background: rgba(79, 168, 150, 0.15); color: #3d8a7a; }
        .status-pending { background: rgba(201, 169, 98, 0.15); color: #9a7c3e; }
        .status-overdue { background: rgba(220, 53, 69, 0.15); color: #dc3545; }
        
        /* Icon styles */
        .icon-sm {
            width: 16px;
            height: 16px;
        }
        
        /* No data message */
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .no-data svg {
            width: 48px;
            height: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <div class="report-page">
        <!-- Report Toolbar -->
        <div class="report-toolbar no-print">
            <h5>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                <span id="toolbarTitle">Report Viewer</span>
            </h5>
            <div class="toolbar-buttons">
                <a href="admin-settings.html" class="btn btn-light">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Back to Reports
                </a>
                <button class="btn btn-warning" onclick="window.print()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                    Print
                </button>
                <button class="btn btn-success" onclick="exportToPDF()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Export PDF
                </button>
            </div>
        </div>

        <!-- Report Container -->
        <div class="report-container" id="reportContainer">
            <!-- Report Header -->
            <div class="report-header">
                <img src="assets/images/IC-LOGO-NEW.png" alt="Combined Insurance Services (St.Lucia) Ltd." style="max-width: 150px; margin-bottom: 15px;">
                <div class="company-name">COMBINED INSURANCE SERVICES (ST.LUCIA) LTD.</div>
                <div class="company-location">P.O. GM 636, GABLEWOODS MALL, CASTRIES, ST.LUCIA</div>
                <div class="report-title" id="reportTitle">Report</div>
            </div>
            
            <!-- Report Meta -->
            <div class="report-meta">
                <div class="meta-item">
                    <span>Report Date</span>
                    <strong id="metaReportDate">--</strong>
                </div>
                <div class="meta-item">
                    <span>Generated By</span>
                    <strong id="metaGeneratedBy">--</strong>
                </div>
                <div class="meta-item">
                    <span>Date Range</span>
                    <strong id="metaDateRange">--</strong>
                </div>
                <div class="meta-item">
                    <span>Report ID</span>
                    <strong id="metaReportId">--</strong>
                </div>
            </div>
            
            <!-- Report Summary -->
            <div class="report-summary" id="reportSummary">
                <h5>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                    Summary
                </h5>
                <div class="summary-grid" id="summaryGrid"></div>
            </div>
            
            <!-- Report Content -->
            <div class="report-content">
                <table class="report-table" id="reportTable">
                    <thead id="reportTableHead"></thead>
                    <tbody id="reportTableBody"></tbody>
                    <tfoot id="reportTableFoot"></tfoot>
                </table>
            </div>
            
            <!-- Report Footer -->
            <div class="report-footer">
                <p class="certification-text">
                    I certify that the information contained in this report is accurate and complete to the best of my knowledge.
                </p>
                
                <div class="signature-section">
                    <div class="signature-box">
                        <div class="signature-line">
                            <div class="signature-title">Prepared By</div>
                        </div>
                    </div>
                    <div class="signature-box">
                        <div class="signature-line">
                            <div class="signature-title">Authorized Signature</div>
                        </div>
                    </div>
                </div>
                
                <div class="generated-info">
                    Report generated on <span id="generatedDate">--</span> at <span id="generatedTime">--</span>
                    by <span id="generatedUser">--</span> | Combined Insurance Services (St.Lucia) Ltd., P.O. GM 636, Gablewoods Mall, Castries, St.Lucia
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="assets/libs/sweetalert2/sweetalert2.min.js"></script>
    
    <script>
        let reportData = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            const storedData = sessionStorage.getItem('reportData');
            
            if (storedData) {
                try {
                    reportData = JSON.parse(storedData);
                    renderReport(reportData);
                } catch (e) {
                    console.error('Error parsing report data:', e);
                    showNoDataMessage();
                }
            } else {
                showNoDataMessage();
            }
        });
        
        function showNoDataMessage() {
            document.getElementById('reportTitle').textContent = 'No Report Available';
            document.getElementById('reportSummary').style.display = 'none';
            document.getElementById('reportTableBody').innerHTML = `
                <tr>
                    <td colspan="10" class="no-data">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        <div><strong>No report data available</strong></div>
                        <div>Please go back and generate a report first.</div>
                    </td>
                </tr>
            `;
        }
        
        function renderReport(data) {
            const now = new Date();
            let userData = { fullName: 'System', role: 'Admin' };
            try {
                const userDataStr = localStorage.getItem('userData');
                if (userDataStr) userData = JSON.parse(userDataStr);
            } catch (e) {}
            
            // Set titles
            const title = data.title || 'Report';
            document.getElementById('toolbarTitle').textContent = title;
            document.getElementById('reportTitle').textContent = title;
            document.title = title + ' | Combined Insurance Services (St.Lucia) Ltd.';
            
            // Set meta info
            document.getElementById('metaReportDate').textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('metaGeneratedBy').textContent = `${userData.fullName || 'System'} (${userData.role || 'Admin'})`;
            document.getElementById('metaDateRange').textContent = data.dateRange || 'All Time';
            document.getElementById('metaReportId').textContent = 'RPT-' + Date.now().toString(36).toUpperCase();
            
            // Set footer info
            document.getElementById('generatedDate').textContent = now.toLocaleDateString();
            document.getElementById('generatedTime').textContent = now.toLocaleTimeString();
            document.getElementById('generatedUser').textContent = userData.fullName || 'System';
            
            // Render summary
            if (data.summary && data.summary.length > 0) {
                let summaryHtml = '';
                data.summary.forEach(item => {
                    summaryHtml += `
                        <div class="summary-item">
                            <div class="value">${item.value}</div>
                            <div class="label">${item.label}</div>
                        </div>
                    `;
                });
                document.getElementById('summaryGrid').innerHTML = summaryHtml;
                document.getElementById('reportSummary').style.display = 'block';
            } else {
                document.getElementById('reportSummary').style.display = 'none';
            }
            
            // Render table headers
            if (data.headers && data.headers.length > 0) {
                let headerHtml = '<tr>';
                data.headers.forEach(h => {
                    headerHtml += `<th>${escapeHtml(h)}</th>`;
                });
                headerHtml += '</tr>';
                document.getElementById('reportTableHead').innerHTML = headerHtml;
            }
            
            // Render table body
            if (data.rows && data.rows.length > 0) {
                let bodyHtml = '';
                data.rows.forEach(row => {
                    bodyHtml += '<tr>';
                    row.forEach((cell) => {
                        let cellClass = '';
                        let cellContent = cell;
                        
                        if (typeof cell === 'string') {
                            if (cell.startsWith('$') || cell.match(/^\$[\d,]+\.?\d*$/)) {
                                cellClass = 'amount-cell';
                            }
                            if (cell === 'Active' || cell === 'Paid') {
                                cellContent = `<span class="status-badge status-active">${cell}</span>`;
                            } else if (cell === 'Pending') {
                                cellContent = `<span class="status-badge status-pending">${cell}</span>`;
                            } else if (cell === 'Overdue' || cell === 'Cancelled') {
                                cellContent = `<span class="status-badge status-overdue">${cell}</span>`;
                            }
                        }
                        bodyHtml += `<td class="${cellClass}">${cellContent}</td>`;
                    });
                    bodyHtml += '</tr>';
                });
                document.getElementById('reportTableBody').innerHTML = bodyHtml;
            } else {
                document.getElementById('reportTableBody').innerHTML = '<tr><td colspan="10" class="no-data">No data available</td></tr>';
            }
            
            // Render totals
            if (data.totals && data.totals.length > 0) {
                let footHtml = '<tr>';
                data.totals.forEach(t => {
                    footHtml += `<td>${t}</td>`;
                });
                footHtml += '</tr>';
                document.getElementById('reportTableFoot').innerHTML = footHtml;
            }
        }
        
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function exportToPDF() {
            const element = document.getElementById('reportContainer');
            const reportTitle = reportData?.title || 'Report';
            
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `IC_${reportTitle.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    letterRendering: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait' 
                }
            };
            
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: 'Generating PDF...',
                    text: 'Please wait...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
            }
            
            html2pdf().set(opt).from(element).save().then(() => {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'Success!',
                        text: 'PDF has been downloaded',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            }).catch(err => {
                console.error('PDF export error:', err);
                if (typeof Swal !== 'undefined') {
                    Swal.fire('Error', 'Failed to generate PDF. Please try printing instead.', 'error');
                }
            });
        }
    </script>
</body>
</html>
