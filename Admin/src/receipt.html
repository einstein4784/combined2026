@@include('partials/main.html')

<head>
    @@include("partials/title-meta.html", {"title": "Receipt"})

    @@include('partials/head-css.html')
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .receipt-container { 
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 15px !important;
            }
        }
        
        .receipt-container {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            padding: 30px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .receipt-header {
            border-bottom: 3px solid #1a365d;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        
        .company-logo {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: -2px;
            line-height: 1;
        }
        
        .company-logo .i { color: #1a365d; }
        .company-logo .amp { color: #c9a962; font-size: 36px; }
        .company-logo .c { color: #4fa896; }
        
        .company-name {
            color: #1a365d;
            font-size: 14px;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .company-address {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .receipt-title {
            background: linear-gradient(135deg, #1a365d 0%, #2c4a7c 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 2px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .receipt-number {
            background: #f8f9fa;
            border-left: 4px solid #c9a962;
            padding: 10px 15px;
            margin-bottom: 20px;
        }
        
        .receipt-number .number {
            font-size: 18px;
            font-weight: 700;
            color: #1a365d;
        }
        
        .info-section {
            margin-bottom: 20px;
        }
        
        .info-section h6 {
            color: #1a365d;
            font-weight: 700;
            border-bottom: 2px solid #4fa896;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #666;
            font-weight: 500;
        }
        
        .info-value {
            color: #333;
            font-weight: 600;
            text-align: right;
        }
        
        .amount-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .amount-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
        }
        
        .amount-row.total {
            border-top: 2px solid #1a365d;
            margin-top: 10px;
            padding-top: 15px;
            font-size: 18px;
        }
        
        .amount-row.total .amount-value {
            color: #4fa896;
            font-size: 24px;
        }
        
        .amount-label {
            color: #333;
            font-weight: 500;
        }
        
        .amount-value {
            color: #1a365d;
            font-weight: 700;
        }
        
        .coverage-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .coverage-badge.fully-comp {
            background: #1a365d;
            color: white;
        }
        
        .coverage-badge.third-party {
            background: #c9a962;
            color: #333;
        }
        
        .receipt-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
            text-align: center;
        }
        
        .receipt-footer p {
            color: #666;
            font-size: 12px;
            margin: 5px 0;
        }
        
        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
        }
        
        .signature-box {
            width: 45%;
            text-align: center;
        }
        
        .signature-line {
            border-top: 1px solid #333;
            margin-top: 50px;
            padding-top: 5px;
            font-size: 12px;
            color: #666;
        }
        
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 100px;
            color: rgba(79, 168, 150, 0.05);
            font-weight: 800;
            pointer-events: none;
            z-index: 0;
        }
        
        .receipt-content {
            position: relative;
            z-index: 1;
        }
        
        .timestamp {
            font-size: 11px;
            color: #999;
            text-align: right;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="layout-wrapper">
        @@include('partials/menu.html')

        <div class="page-content">
            @@include('partials/topbar.html')

            <div class="px-3">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="card no-print">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h4 class="header-title">Payment Receipt</h4>
                                        <div>
                                            <button type="button" class="btn btn-outline-secondary me-2" onclick="window.history.back()">
                                                <i data-lucide="arrow-left" class="icon-sm me-1"></i> Back
                                            </button>
                                            <button type="button" class="btn btn-primary" onclick="window.print()">
                                                <i data-lucide="printer" class="icon-sm me-1"></i> Print Receipt
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="receipt-container print-area" id="receiptContent">
                                <div class="watermark">PAID</div>
                                <div class="receipt-content">
                                    <!-- Header -->
                                    <div class="receipt-header">
                                        <div class="row align-items-center">
                                            <div class="col-6">
                                                <div class="company-logo">
                                                    <span class="i">I</span><span class="amp">&</span><span class="c">C</span>
                                                </div>
                                                <div class="company-name">Insurance Brokers</div>
                                                <div class="company-address">
                                                    St. Lucia, West Indies<br>
                                                    Tel: +1-758-XXX-XXXX<br>
                                                    Email: info@ic-insurance.com
                                                </div>
                                            </div>
                                            <div class="col-6 text-end">
                                                <div class="receipt-number">
                                                    <small class="text-muted">Receipt No.</small>
                                                    <div class="number" id="receiptNumber">---</div>
                                                </div>
                                                <div class="text-muted">
                                                    <small>Date: <span id="paymentDate">---</span></small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="receipt-title">OFFICIAL PAYMENT RECEIPT</div>
                                    
                                    <!-- Customer Information -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="info-section">
                                                <h6><i data-lucide="user" class="icon-sm me-2"></i>Customer Information</h6>
                                                <div class="info-row">
                                                    <span class="info-label">Name:</span>
                                                    <span class="info-value" id="customerName">---</span>
                                                </div>
                                                <div class="info-row">
                                                    <span class="info-label">ID Number:</span>
                                                    <span class="info-value" id="customerIdNumber">---</span>
                                                </div>
                                                <div class="info-row">
                                                    <span class="info-label">Contact:</span>
                                                    <span class="info-value" id="customerContact">---</span>
                                                </div>
                                                <div class="info-row">
                                                    <span class="info-label">Email:</span>
                                                    <span class="info-value" id="customerEmail">---</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="info-section">
                                                <h6><i data-lucide="file-text" class="icon-sm me-2"></i>Policy Information</h6>
                                                <div class="info-row">
                                                    <span class="info-label">Policy No:</span>
                                                    <span class="info-value" id="policyNumber">---</span>
                                                </div>
                                                <div class="info-row">
                                                    <span class="info-label">Coverage Type:</span>
                                                    <span class="info-value" id="coverageType">---</span>
                                                </div>
                                                <div class="info-row">
                                                    <span class="info-label">Coverage Period:</span>
                                                    <span class="info-value" id="coveragePeriod">---</span>
                                                </div>
                                                <div class="info-row">
                                                    <span class="info-label">Policy Status:</span>
                                                    <span class="info-value" id="policyStatus">---</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Payment Details -->
                                    <div class="amount-section">
                                        <h6 class="text-center mb-3" style="color: #1a365d; font-weight: 700;">
                                            <i data-lucide="credit-card" class="icon-sm me-2"></i>Payment Details
                                        </h6>
                                        <div class="amount-row">
                                            <span class="amount-label">Total Premium Due:</span>
                                            <span class="amount-value" id="totalPremium">$0.00</span>
                                        </div>
                                        <div class="amount-row">
                                            <span class="amount-label">Previous Payments:</span>
                                            <span class="amount-value" id="previousPayments">$0.00</span>
                                        </div>
                                        <div class="amount-row">
                                            <span class="amount-label">Payment Method:</span>
                                            <span class="amount-value" id="paymentMethod">---</span>
                                        </div>
                                        <div class="amount-row total">
                                            <span class="amount-label" style="font-size: 18px; font-weight: 700;">Amount Paid:</span>
                                            <span class="amount-value" id="amountPaid">$0.00</span>
                                        </div>
                                        <div class="amount-row">
                                            <span class="amount-label">Outstanding Balance:</span>
                                            <span class="amount-value text-danger" id="outstandingBalance">$0.00</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Signatures -->
                                    <div class="signature-section">
                                        <div class="signature-box">
                                            <div class="signature-line">Customer Signature</div>
                                        </div>
                                        <div class="signature-box">
                                            <div class="signature-line">Authorized Signature</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Footer -->
                                    <div class="receipt-footer">
                                        <p><strong>Thank you for your payment!</strong></p>
                                    </div>
                                    
                                    <div class="timestamp">
                                        Generated: <span id="generatedTimestamp">---</span> by <span id="generatedBy">---</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @@include('partials/footer.html')
        </div>
    </div>

    @@include('partials/footer-scripts.html')
    <script>
        $(document).ready(function() {
            // Wait a bit for all scripts to load
            setTimeout(function() {
                const urlParams = new URLSearchParams(window.location.search);
                const receiptNumber = urlParams.get('receipt');
                
                if (receiptNumber) {
                    console.log('Loading receipt:', receiptNumber);
                    loadReceipt(receiptNumber);
                } else {
                    $('#receiptContent').html('<div class="text-center text-danger p-5"><h4>No receipt specified</h4><p>Please provide a receipt number in the URL</p></div>');
                }
            }, 100);
        });
        
        async function loadReceipt(receiptNumber) {
            // Show loading overlay instead of replacing content
            // First, hide the receipt content temporarily
            $('.receipt-content').css('opacity', '0.3');
            const loadingOverlay = $('<div id="receiptLoadingOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column;"><div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div><p class="mt-3">Loading receipt...</p></div>');
            $('body').append(loadingOverlay);
            
            const API_BASE_URL = 'http://localhost:3001';
            const receiptUrl = `${API_BASE_URL}/api/receipts/${encodeURIComponent(receiptNumber)}`;
            
            console.log('Fetching receipt from:', receiptUrl);
            
            try {
                const response = await fetch(receiptUrl, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        const errorText = await response.text();
                        if (errorText) errorMessage = errorText;
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                console.log('Receipt data received:', data);
                
                if (!data || !data.receipt_number) {
                    throw new Error('Invalid receipt data received from server');
                }
                
                // Remove loading overlay and restore opacity
                $('#receiptLoadingOverlay').remove();
                $('.receipt-content').css('opacity', '1');
                
                // Display receipt data
                displayReceipt(data);
            } catch (error) {
                console.error('Error loading receipt:', error);
                
                // Remove loading overlay and restore opacity
                $('#receiptLoadingOverlay').remove();
                $('.receipt-content').css('opacity', '1');
                
                const errorMessage = error.message || 'Could not load receipt. Please check your connection and try again.';
                
                // Replace receipt content with error message
                $('#receiptContent .receipt-content').html(`
                    <div class="text-center text-danger p-5">
                        <h4><i data-lucide="alert-circle" class="icon-sm me-2"></i>Error Loading Receipt</h4>
                        <p class="mt-3">${errorMessage}</p>
                        <p class="mt-2"><small>Receipt Number: <strong>${receiptNumber}</strong></small></p>
                        <div class="mt-4">
                            <button class="btn btn-primary me-2" onclick="location.reload()">
                                <i data-lucide="refresh-cw" class="icon-sm me-1"></i> Retry
                            </button>
                            <button class="btn btn-outline-secondary" onclick="window.history.back()">
                                <i data-lucide="arrow-left" class="icon-sm me-1"></i> Go Back
                            </button>
                        </div>
                    </div>
                `);
                
                // Initialize icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'Error',
                        text: errorMessage,
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            }
        }
        
        function displayReceipt(data) {
            try {
                console.log('Displaying receipt data:', data);
                
                // Receipt info
                if ($('#receiptNumber').length) $('#receiptNumber').text(data.receipt_number || '---');
                if ($('#paymentDate').length) $('#paymentDate').text(formatDate(data.payment_date || data.payment_date));
                
                // Customer info
                if ($('#customerName').length) $('#customerName').text(data.customer_name || '---');
                if ($('#customerIdNumber').length) $('#customerIdNumber').text(data.customer_id_number || '---');
                if ($('#customerContact').length) $('#customerContact').text(data.customer_contact || '---');
                if ($('#customerEmail').length) $('#customerEmail').text(data.customer_email || '---');
                
                // Policy info
                if ($('#policyNumber').length) $('#policyNumber').text(data.policy_number || '---');
                
                // Coverage type with badge
                if ($('#coverageType').length) {
                    const coverageType = data.coverage_type || 'Third Party';
                    const badgeClass = coverageType === 'Fully Comprehensive' ? 'fully-comp' : 'third-party';
                    $('#coverageType').html(`<span class="coverage-badge ${badgeClass}">${coverageType}</span>`);
                }
                
                // Coverage period
                if ($('#coveragePeriod').length) {
                    const startDate = data.coverage_start_date ? formatDate(data.coverage_start_date) : '---';
                    const endDate = data.coverage_end_date ? formatDate(data.coverage_end_date) : '---';
                    $('#coveragePeriod').text(`${startDate} to ${endDate}`);
                }
                
                if ($('#policyStatus').length) {
                    $('#policyStatus').html(`<span class="badge bg-success">${data.policy_status || 'Active'}</span>`);
                }
                
                // Payment info
                if ($('#totalPremium').length) $('#totalPremium').text(formatCurrency(data.total_premium_due || 0));
                if ($('#previousPayments').length) $('#previousPayments').text(formatCurrency((data.amount_paid_before || 0)));
                if ($('#paymentMethod').length) $('#paymentMethod').text(data.payment_method || 'Cash');
                if ($('#amountPaid').length) $('#amountPaid').text(formatCurrency(data.amount || 0));
                if ($('#outstandingBalance').length) $('#outstandingBalance').text(formatCurrency(data.outstanding_balance || 0));
                
                // Timestamps
                if ($('#generatedTimestamp').length) {
                    $('#generatedTimestamp').text(formatDateTime(data.generated_at || data.payment_date || new Date()));
                }
                if ($('#generatedBy').length) {
                    $('#generatedBy').text(data.generated_by_name || 'System');
                }
                
                // Make sure receipt content is visible
                $('#receiptContent').show();
                
                // Initialize icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                
                console.log('Receipt displayed successfully');
            } catch (error) {
                console.error('Error in displayReceipt:', error);
                $('#receiptContent').html(`
                    <div class="text-center text-danger p-5">
                        <h4>Error Displaying Receipt</h4>
                        <p>${error.message || 'An error occurred while displaying the receipt'}</p>
                        <pre style="text-align: left; margin-top: 20px; font-size: 12px;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `);
            }
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '---';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        
        function formatDateTime(dateStr) {
            if (!dateStr) return '---';
            const date = new Date(dateStr);
            return date.toLocaleString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount || 0);
        }
    </script>
</body>
</html>
